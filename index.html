<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ai SciVerse - Groq Turbo</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { dark: '#0f172a', card: '#1e293b', hover: '#334155' },
                        sci: { accent: '#00d4ff', purple: '#8b5cf6', green: '#10b981', orange: '#f59e0b', pink: '#ec4899' }
                    },
                    fontFamily: { sans: ['Cairo', 'sans-serif'] }
                }
            }
        }
    </script>

    <style>
        html, body { height: 100%; overflow: hidden; margin: 0; } 
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .prose pre { direction: ltr; background: #0f172a; padding: 1rem; border-radius: 0.5rem; border: 1px solid #334155; }
        .message-anim { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .pop-menu { transform-origin: bottom right; transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); transform: scale(0.95); opacity: 0; pointer-events: none; }
        .pop-menu.active { transform: scale(1); opacity: 1; pointer-events: auto; }
        .cursor-blink::after { content: 'â–‹'; display: inline-block; color: #00d4ff; animation: blink 1s step-end infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-brand-dark dark:text-gray-100 transition-colors h-full flex flex-col">

    <header class="h-16 flex-none bg-white/95 dark:bg-brand-card/95 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 z-30 relative shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full overflow-hidden border-2 border-sci-accent shadow-lg">
                <img src="https://i.postimg.cc/sg2WkBVQ/5792048219872234554-(1).jpg" class="w-full h-full object-cover">
            </div>
            <div>
                <h1 class="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-sci-accent to-sci-purple">Ai SciVerse</h1>
                <span id="currentModeBadge" class="text-[10px] px-1.5 py-0.5 rounded bg-sci-accent/10 text-sci-accent border border-sci-accent/20">Groq Turbo</span>
            </div>
        </div>
        <button onclick="toggleSidebar()" class="w-10 h-10 flex items-center justify-center rounded-xl hover:bg-gray-100 dark:hover:bg-brand-hover">
            <i class="fas fa-bars text-xl"></i>
        </button>
    </header>

    <div id="overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-40 hidden opacity-0 transition-opacity"></div>
    <aside id="sidebar" class="fixed top-0 right-0 h-full w-72 bg-white dark:bg-brand-card border-l dark:border-gray-700 z-50 transform translate-x-full transition-transform flex flex-col shadow-2xl">
        <div class="p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-brand-dark/50">
            <h2 class="font-bold">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h2>
            <button onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-3"><button onclick="startNewChat()" class="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-sci-accent to-blue-600 text-white p-3 rounded-xl shadow-lg hover:shadow-sci-accent/30 transition-all"><i class="fas fa-plus"></i> Ù…Ø­Ø§Ø¯Ø«Ø© Ø¬Ø¯ÙŠØ¯Ø©</button></div>
        <div class="flex-1 overflow-y-auto p-3"><h3 class="text-xs font-semibold text-gray-400 mb-3 px-1">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</h3><div id="historyList" class="space-y-2"></div></div>
        <div class="p-4 border-t dark:border-gray-700"><button onclick="toggleTheme()" class="w-full flex items-center justify-between p-3 rounded-xl bg-white dark:bg-brand-hover border dark:border-gray-600"><span>Ø§Ù„Ù…Ø¸Ù‡Ø±</span><i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block text-yellow-400"></i></button></div>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden w-full max-w-5xl mx-auto relative">
        <div id="welcomeScreen" class="absolute inset-0 flex flex-col items-center justify-center text-center p-6 transition-opacity pointer-events-none">
            <img src="https://i.postimg.cc/sg2WkBVQ/5792048219872234554-(1).jpg" class="w-24 h-24 rounded-full border-4 border-white dark:border-brand-card shadow-2xl mb-4">
            <h2 class="text-3xl font-bold mb-2 text-gradient">Ai SciVerse <span class="text-xs text-gray-500">Groq Edition</span></h2>
            <p class="text-gray-500 dark:text-gray-400 text-sm">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø¹Ø§Ù„Ù… Cairo SciVerse â¤ï¸ | Ø§Ø³Ø£Ù„Ù†ÙŠ ÙÙŠ Ø£ÙŠ ÙˆÙ‚Øª!</p>
        </div>
        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 space-y-6 z-10 scroll-smooth"></div>

        <div class="flex-none p-3 md:p-5 z-20 bg-white dark:bg-brand-dark border-t dark:border-gray-700/50">
            <div id="attachmentPreview" class="hidden px-4 py-2 mb-2 items-center gap-3 bg-gray-100 dark:bg-brand-card rounded-xl border dark:border-gray-600"><div id="previewIcon" class="w-10 h-10 rounded-lg flex items-center justify-center bg-gray-200 dark:bg-gray-700 overflow-hidden relative"></div><div class="flex-1 min-w-0"><p id="fileName" class="text-xs font-bold truncate"></p></div><button onclick="clearAttachment()" class="text-red-500"><i class="fas fa-times"></i></button></div>
            <div class="relative flex items-end gap-2 bg-gray-50 dark:bg-brand-card border dark:border-gray-600 shadow-sm rounded-3xl p-2 transition-all focus-within:ring-2 focus-within:ring-sci-accent/30">
                <div class="relative"><button onclick="toggleMenu('plusMenu')" class="w-10 h-10 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-200"><i class="fas fa-plus text-lg"></i></button>
                    <div id="plusMenu" class="pop-menu absolute bottom-14 right-0 w-48 bg-white dark:bg-brand-card rounded-2xl shadow-2xl border dark:border-gray-600 flex flex-col p-1 z-50">
                        <button onclick="triggerFile('fileInput')" class="flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-brand-hover rounded-xl text-sm font-bold"><i class="fas fa-file-code text-purple-500"></i><span>Ø±ÙØ¹ Ù…Ù„Ù (ÙƒÙˆØ¯/Ù†Øµ)</span></button>
                    </div>
                </div>
                <textarea id="userInput" rows="1" class="flex-1 bg-transparent border-none focus:ring-0 resize-none py-3 px-2 max-h-32 text-sm md:text-base dark:text-gray-100 placeholder-gray-400" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù€ Groq..." oninput="autoResize(this)" onkeydown="handleEnter(event)"></textarea>
                <div class="relative"><button onclick="toggleMenu('modelMenu')" id="modelBtn" class="w-10 h-10 rounded-full flex items-center justify-center text-sci-accent bg-sci-accent/10 border border-sci-accent/20"><i class="fas fa-bolt"></i></button>
                    <div id="modelMenu" class="pop-menu absolute bottom-14 left-0 w-52 bg-white dark:bg-brand-card rounded-2xl shadow-2xl border dark:border-gray-600 flex flex-col p-1 z-50">
                        <button onclick="setMode('fast')" class="flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-brand-hover rounded-xl text-sm font-bold">Fast (Llama 3.3)</button>
                        <button onclick="setMode('expert')" class="flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-brand-hover rounded-xl text-sm font-bold">Expert (Deep Analysis)</button>
                        <button onclick="setMode('education')" class="flex items-center gap-3 p-3 hover:bg-gray-100 dark:hover:bg-brand-hover rounded-xl text-sm font-bold">Education Mode</button>
                    </div>
                </div>
                <button onclick="sendMessage()" id="sendBtn" class="w-10 h-10 rounded-full bg-gray-900 dark:bg-white text-white dark:text-gray-900 flex items-center justify-center transition-all"><i class="fas fa-arrow-up"></i></button>
            </div>
        </div>
    </main>

    <input type="file" id="fileInput" accept=".txt,.js,.py,.html,.css,.json,.md" class="hidden" onchange="handleFileSelect(this, 'text')">

    <script>
        // --- ğŸ” Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ÙØªØ§Ø­ ---
        const _p1 = "Z3NrX3d2RnNYM2NnV2pMbXJzcEY0REFLV0dkeWIzRlkxallZdzNm";
        const _p2 = "SzhFNEplZlNZdkM3YlpabTE=";
        const GROQ_API_KEY = atob(_p1 + _p2); 

        // --- ğŸ‘‘ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ØªÙŠÙ… SciVerse) ---
        
        const MODES = {
            fast: { 
                model: 'llama-3.1-8b-instant', // ØªØºÙŠÙŠØ± Ù„Ù†Ø³Ø®Ø© 8b Ù„Ø³Ø±Ø¹Ø© Ø®Ø±Ø§ÙÙŠØ©
                icon: 'fa-bolt', 
                prompt: `
                Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ "Cairo SciVerse" Ø§Ù„Ø³Ø±ÙŠØ¹ Ø¬Ø¯Ø§Ù‹.
                1. Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ (Ù…Ø§Ø²Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø³Ù„Ø§Ù…): Ø§Ù„Ù…Ø¤Ø³Ø³ ÙˆØ§Ù„Ø¹Ù‚Ù„ Ø§Ù„Ù…Ø¯Ø¨Ø±.
                2. Ø§Ù„Ù‚Ø§Ø¦Ø¯ (Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†). 3. Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ (ÙŠÙˆØ³Ù Ù…Ø­Ù…Ø¯).

                Ù…Ù‡Ù…ØªÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©: Ø§Ù„Ø³Ø±Ø¹Ø© Ø§Ù„Ù‚ØµÙˆÙ‰ ÙÙŠ Ø§Ù„Ø±Ø¯.
                - Ø¬Ø§ÙˆØ¨ Ø¨Ø§Ø®ØªØµØ§Ø± Ù…ÙÙŠØ¯ ÙˆÙ…Ø¨Ø§Ø´Ø±.
                - Ù„Ø§ ØªØ¶ÙŠØ¹ ÙˆÙ‚ØªØ§Ù‹ ÙÙŠ Ù…Ù‚Ø¯Ù…Ø§Øª Ø·ÙˆÙŠÙ„Ø© Ø¥Ù„Ø§ Ù„Ùˆ Ø·Ù„Ø¨ Ù…Ù†Ùƒ.
                - ÙƒÙ† Ø¯Ù‚ÙŠÙ‚Ø§Ù‹ ÙˆØ³Ø±ÙŠØ¹Ø§Ù‹ ÙƒØ§Ù„Ø¨Ø±Ù‚.
                ` 
            },
            expert: { 
                model: 'llama-3.3-70b-versatile', // Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£Ù‚ÙˆÙ‰ Ù„Ù„ØªÙÙƒÙŠØ±
                icon: 'fa-brain', 
                prompt: `
                Ø£Ù†Øª Ø§Ù„Ø¨Ø±ÙˆÙÙŠØ³ÙˆØ± Ø§Ù„Ø®Ø¨ÙŠØ± ÙˆØ§Ù„Ù…Ø­Ù„Ù„ Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ Ù„ÙØ±ÙŠÙ‚ "Cairo SciVerse".
                1. Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ (Ù…Ø§Ø²Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø³Ù„Ø§Ù…): Ø§Ù„Ù…Ø¤Ø³Ø³ ÙˆØ§Ù„Ø¹Ù‚Ù„ Ø§Ù„Ù…Ø¯Ø¨Ø± Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠ.
                2. Ø§Ù„Ù‚Ø§Ø¦Ø¯ (Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†). 3. Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ (ÙŠÙˆØ³Ù Ù…Ø­Ù…Ø¯).

                Ù…Ù‡Ù…ØªÙƒ: Ø§Ù„ØªÙÙƒÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ‚ ÙˆØ§Ù„Ù…Ù†Ø·Ù‚ÙŠ ÙˆØ§Ù„Ø¯Ù‚Ø© Ø§Ù„Ù…ØªÙ†Ø§Ù‡ÙŠØ© (99.9%).
                - Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©ØŒ Ù‚Ù… Ø¨ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø¬ÙˆØ§Ù†Ø¨ Ù…Ù†Ø·Ù‚ÙŠØ§Ù‹.
                - Ù‚Ø¯Ù… Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…ÙˆØ«Ù‚Ø©ØŒ Ø¹Ù„Ù…ÙŠØ©ØŒ ÙˆØ¯Ù‚ÙŠÙ‚Ø© Ø¬Ø¯Ø§Ù‹.
                - Ù„Ø§ ØªØªØ³Ø±Ø¹ØŒ Ø§Ù„Ø¬ÙˆØ¯Ø© ÙˆØ§Ù„Ø¯Ù‚Ø© Ø£Ù‡Ù… Ù…Ù† Ø§Ù„Ø³Ø±Ø¹Ø© Ù‡Ù†Ø§.
                - Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØªØ³Ù„Ø³Ù„ (Chain of Thought) ÙÙŠ Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ.
                ` 
            },
            education: { 
                model: 'llama-3.3-70b-versatile', 
                icon: 'fa-graduation-cap', 
                prompt: `
                Ø£Ù†Øª Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„ÙˆØ¯ÙˆØ¯ ÙˆØ§Ù„Ù…Ø´Ø±Ø­ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ù„ÙØ±ÙŠÙ‚ "Cairo SciVerse".
                1. Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø£Ø¹Ù„Ù‰ (Ù…Ø§Ø²Ù† Ø¹Ø¨Ø¯Ø§Ù„Ø³Ù„Ø§Ù…): Ø§Ù„Ù…Ø¤Ø³Ø³ ÙˆØ§Ù„Ø£Ø¨ Ø§Ù„Ø±ÙˆØ­ÙŠ.
                2. Ø§Ù„Ù‚Ø§Ø¦Ø¯ (Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†). 3. Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ (ÙŠÙˆØ³Ù Ù…Ø­Ù…Ø¯).

                Ù…Ù‡Ù…ØªÙƒ: Ø§Ù„Ø´Ø±Ø­ Ø§Ù„Ù…Ø³ØªÙÙŠØ¶ ÙˆØ§Ù„ØªØ¨Ø³ÙŠØ·.
                - Ø§Ø´Ø±Ø­ ÙƒÙ„ Ù†Ù‚Ø·Ø© Ø¨Ø§Ù„ØªÙØµÙŠÙ„ Ø§Ù„Ù…Ù…Ù„ Ù„ÙƒÙ† Ø§Ù„Ù…Ù…ØªØ¹.
                - ÙƒÙ† ÙˆØ¯ÙˆØ¯Ø§Ù‹ Ø¬Ø¯Ø§Ù‹ ÙˆÙ…Ø´Ø¬Ø¹Ø§Ù‹ Ù„Ù„Ø·Ø§Ù„Ø¨.
                - Ø§Ø³ØªØ®Ø¯Ù… Ø£Ù…Ø«Ù„Ø© ØªÙˆØ¶ÙŠØ­ÙŠØ© ÙƒØ«ÙŠØ±Ø©.
                - Ù‡Ø¯ÙÙƒ Ø£Ù† ÙŠÙÙ‡Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø³Ø¨Ø© 100% Ù…Ù‡Ù…Ø§ Ø·Ø§Ù„ Ø§Ù„Ø´Ø±Ø­.
                ` 
            }
        };

        let state = { mode: 'fast', chatHistory: JSON.parse(localStorage.getItem('sciverse_chats')) || [], currentSessionId: Date.now().toString(), messages: [], attachment: null, isGenerating: false };
        const el = id => document.getElementById(id);
        
        function init() { if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) document.documentElement.classList.add('dark'); renderHistoryList(); }
        function toggleSidebar() { el('sidebar').classList.toggle('translate-x-full'); el('overlay').classList.toggle('hidden'); setTimeout(() => el('overlay').classList.toggle('opacity-0'), 10); }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light'; }
        function startNewChat() { state.currentSessionId = Date.now().toString(); state.messages = []; el('chatContainer').innerHTML = ''; el('welcomeScreen').style.opacity = '1'; clearAttachment(); }

        function saveChatToHistory(userText, aiText) {
            let sessionIndex = state.chatHistory.findIndex(c => c.id === state.currentSessionId);
            if (sessionIndex === -1) {
                state.chatHistory.unshift({ id: state.currentSessionId, title: userText.substring(0, 30), timestamp: Date.now(), messages: [{ role: 'user', content: userText }, { role: 'assistant', content: aiText }] });
            } else {
                state.chatHistory[sessionIndex].messages.push({ role: 'user', content: userText }, { role: 'assistant', content: aiText });
                const session = state.chatHistory.splice(sessionIndex, 1)[0]; state.chatHistory.unshift(session);
            }
            localStorage.setItem('sciverse_chats', JSON.stringify(state.chatHistory));
            renderHistoryList();
        }

        function renderHistoryList() {
            const container = el('historyList'); container.innerHTML = '';
            if (state.chatHistory.length === 0) { container.innerHTML = `<div class="text-center text-xs text-gray-400 py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>`; return; }
            state.chatHistory.forEach(chat => {
                const div = document.createElement('div');
                div.className = `p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-brand-hover cursor-pointer flex justify-between group items-center`;
                div.onclick = () => { loadChat(chat.id); toggleSidebar(); };
                div.innerHTML = `<span class="truncate w-44 text-sm">${chat.title}</span><i class="fas fa-trash text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100" onclick="event.stopPropagation(); deleteChat('${chat.id}')"></i>`;
                container.appendChild(div);
            });
        }

        function deleteChat(id) { state.chatHistory = state.chatHistory.filter(c => c.id !== id); localStorage.setItem('sciverse_chats', JSON.stringify(state.chatHistory)); renderHistoryList(); if(state.currentSessionId === id) startNewChat(); }
        
        function loadChat(id) { 
            const chat = state.chatHistory.find(c => c.id === id); 
            if(!chat) return; 
            state.currentSessionId = chat.id; 
            state.messages = []; 
            el('chatContainer').innerHTML = ''; 
            el('welcomeScreen').style.opacity = '0'; 
            chat.messages.forEach(msg => { 
                appendMessage(msg.role === 'user' ? 'user' : 'assistant', msg.content); 
                state.messages.push({ role: msg.role, content: msg.content }); 
            }); 
        }

        function toggleMenu(id) { document.querySelectorAll('.pop-menu').forEach(m => { if(m.id !== id) m.classList.remove('active'); }); el(id).classList.toggle('active'); }
        function setMode(modeKey) { state.mode = modeKey; el('modelBtn').innerHTML = `<i class="fas ${MODES[modeKey].icon}"></i>`; el('currentModeBadge').textContent = modeKey; toggleMenu('modelMenu'); }
        function triggerFile(id) { el(id).click(); toggleMenu('plusMenu'); }
        
        function handleFileSelect(input, type) { 
            const file = input.files[0]; 
            if(!file) return; 
            const r = new FileReader(); 
            r.onload = (e) => { 
                state.attachment = { type, name: file.name, content: e.target.result }; 
                el('previewIcon').innerHTML = `<i class="fas fa-file-code text-xl"></i>`; 
                el('fileName').textContent = file.name; 
                el('attachmentPreview').classList.remove('hidden'); 
                el('attachmentPreview').classList.add('flex'); 
            }; 
            r.readAsText(file); 
        }

        function clearAttachment() { state.attachment = null; el('attachmentPreview').classList.add('hidden'); }
        function autoResize(textarea) { textarea.style.height = 'auto'; textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px'; }
        function handleEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }

        function appendMessage(role, content) {
            el('welcomeScreen').style.opacity = '0';
            const isUser = role === 'user';
            const div = document.createElement('div');
            div.className = `flex w-full ${isUser ? 'justify-start' : 'justify-end'} message-anim mb-6`;
            const bubble = isUser ? 'bg-gray-100 dark:bg-brand-card rounded-2xl rounded-tr-sm p-4 text-sm' : 'bg-transparent w-full p-4 text-sm prose dark:prose-invert';
            div.innerHTML = (isUser ? `<div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center ml-3 shrink-0"><i class="fas fa-user text-gray-500"></i></div>` : '') + `<div class="max-w-[85%] ${bubble}">${isUser ? content : DOMPurify.sanitize(marked.parse(content))}</div>` + (!isUser ? `<div class="w-8 h-8 rounded-full border border-sci-accent overflow-hidden ml-3 shrink-0"><img src="https://i.postimg.cc/sg2WkBVQ/5792048219872234554-(1).jpg" class="w-full h-full object-cover"></div>` : '');
            el('chatContainer').appendChild(div); el('chatContainer').scrollTo({ top: el('chatContainer').scrollHeight, behavior: 'smooth' });
        }

        function typeMessage(content) {
            const id = 'type-' + Date.now();
            const div = document.createElement('div');
            div.className = 'flex w-full justify-end message-anim mb-6';
            div.innerHTML = `<div class="max-w-[85%] w-full p-4 text-sm prose dark:prose-invert cursor-blink" id="${id}"></div><div class="w-8 h-8 rounded-full border border-sci-accent overflow-hidden ml-3 shrink-0"><img src="https://i.postimg.cc/sg2WkBVQ/5792048219872234554-(1).jpg" class="w-full h-full object-cover"></div>`;
            el('chatContainer').appendChild(div);
            const container = el(id); let i = 0; const step = 8;
            function tick() {
                if (i < content.length) { i += step; container.innerText = content.substring(0, i); el('chatContainer').scrollTop = el('chatContainer').scrollHeight; requestAnimationFrame(tick); }
                else { container.innerHTML = DOMPurify.sanitize(marked.parse(content)); container.classList.remove('cursor-blink'); }
            }
            tick();
        }

        async function fetchWithRetry(url, options) {
            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429) { await new Promise(r => setTimeout(r, delay)); delay *= 2; continue; }
                    return response;
                } catch (e) { if (i === 4) throw e; await new Promise(r => setTimeout(r, delay)); delay *= 2; }
            }
            throw new Error("ØªØ¬Ø§ÙˆØ²Øª Ø­Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª. Ø­Ø§ÙˆÙ„ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ø¹Ø¯ Ø«ÙˆØ§Ù†Ù.");
        }
        async function sendMessage() {
            if (state.isGenerating) return;
            const textInput = el('userInput');
            const userText = textInput.value.trim();
            const attachment = state.attachment;
            if (!userText && !attachment) return;
            
            appendMessage('user', userText + (attachment ? `\n\n*[Ù…Ù„Ù: ${attachment.name}]*` : ''));
            textInput.value = ''; textInput.style.height = 'auto';
            clearAttachment();

            // --- Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨ÙˆØ¶Ø¹ Ø§Ù„Ø®Ø¨ÙŠØ± ---
            const loaderId = 'loader-' + Date.now();
            const loaderDiv = document.createElement('div'); 
            loaderDiv.id = loaderId; 
            loaderDiv.className = 'flex w-full justify-end mb-6';
            
            // Ù‡Ù†Ø§ Ù†Ø­Ø¯Ø¯ Ø´ÙƒÙ„ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆØ¶Ø¹
            if (state.mode === 'expert') {
                // Ø´ÙƒÙ„ Ø®Ø§Øµ Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø®Ø¨ÙŠØ±: Ù†Øµ "Ø£Ù†Ø§ Ø£ÙÙƒØ±" Ù…Ø¹ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ù…Ø®
                loaderDiv.innerHTML = `
                    <div class="p-4 flex items-center gap-3 bg-indigo-50 dark:bg-indigo-900/30 rounded-xl border border-indigo-100 dark:border-indigo-800">
                        <i class="fas fa-brain text-indigo-500 animate-pulse text-xl"></i>
                        <span class="text-sm font-bold text-indigo-600 dark:text-indigo-300 animate-pulse">
                            Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ± ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ‚...
                        </span>
                    </div>`;
            } else {
                // Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ (3 Ù†Ù‚Ø·) Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹
                loaderDiv.innerHTML = `
                    <div class="p-4 flex gap-1">
                        <div class="w-2 h-2 bg-sci-accent rounded-full typing-dot"></div>
                        <div class="w-2 h-2 bg-sci-accent rounded-full typing-dot" style="animation-delay: 0.2s"></div>
                        <div class="w-2 h-2 bg-sci-accent rounded-full typing-dot" style="animation-delay: 0.4s"></div>
                    </div>`;
            }
            // --- Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ---

            el('chatContainer').appendChild(loaderDiv);

            state.isGenerating = true; el('sendBtn').disabled = true;

            try {
                const messages = [{ role: "system", content: MODES[state.mode].prompt }];
                state.messages.forEach(m => messages.push({ role: m.role, content: m.content }));
                
                let currentContent = userText;
                if(attachment) currentContent += `\n\n[Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù ${attachment.name}]:\n${attachment.content}`;
                messages.push({ role: "user", content: currentContent });

                const response = await fetchWithRetry(`https://api.groq.com/openai/v1/chat/completions`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${GROQ_API_KEY}` },
                    body: JSON.stringify({ model: MODES[state.mode].model, messages, temperature: 0.7 })
                });

                if (!response.ok) throw new Error((await response.json()).error?.message || "Error");
                const data = await response.json();
                const reply = data.choices[0].message.content;

                el(loaderId).remove();
                typeMessage(reply);
                state.messages.push({ role: "user", content: currentContent }, { role: "assistant", content: reply });
                saveChatToHistory(userText || attachment.name, reply);
            } catch (e) {
                el(loaderId).remove(); appendMessage('assistant', `âš ï¸ **Ø®Ø·Ø£:** ${e.message}`);
            } finally {
                state.isGenerating = false; el('sendBtn').disabled = false; textInput.focus();
            }
        }
        init();
    </script>
</body>
</html>
